<!DOCTYPE html>
<html>
<head>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    .header {
      background: #4a4a4a;
      color: white;
      padding: 12px 16px;
      font-size: 14px;
      font-weight: 500;
    }
    
    .tabs {
      display: flex;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    
    .tab {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      color: #666;
      border-right: 1px solid #e9ecef;
      position: relative;
      background: #f8f9fa;
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .tab:last-child {
      border-right: none;
    }
    
    .tab.active {
      color: #333;
      background: white;
      font-weight: 500;
      border-bottom-color: #333;
    }
    
    .tab-radio {
      width: 12px;
      height: 12px;
      border: 2px solid #ccc;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
      position: relative;
    }
    
    .tab.active .tab-radio {
      border-color: #333;
      background: #333;
    }
    
    .tab.completed .tab-radio {
      border-color: #28a745;
      background: #28a745;
    }
    
    .tab.completed .tab-radio::after {
      content: '‚úì';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 10px;
      font-weight: bold;
      line-height: 1;
    }
    
    .content {
      background: white;
      padding: 20px;
      flex: 1;
      overflow-y: auto;
    }
    
    .section-header {
      border-radius: 4px;
      margin-bottom: 16px;
    }
    
    .validation-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .validation-text {
      flex: 1;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    
    .section-subtitle {
      font-size: 12px;
      color: #666;
    }
    
    .checklist-item {
      display: flex;
      align-items: flex-start;
      padding: 10px 10px 3px 10px;
      background: #F4F4F4;
      border-radius: 6px;
      margin-bottom: 6px;
    }
    
    .checklist-item:last-child {
      border-bottom: none;
    }
    
    .checkbox {
      width: 16px;
      height: 16px;
      margin-right: 6px;
      margin-top: 0px;
      cursor: pointer;
      accent-color: #333;
    }
    
    .item-content {
      flex: 1;
    }
    
    .item-label {
      font-size: 13px;
      color: #333;
      margin-bottom: 4px;
      font-weight: 500;
    }
    
    .item-completion {
      font-size: 11px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .user-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 1px solid #e9ecef;
      flex-shrink: 0;
    }
    
    .user-initials {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #007acc;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    /* Add margin only when not inside a pill */
    .completion-info .user-avatar:not(.completion-pill .user-avatar),
    .completion-info .user-initials:not(.completion-pill .user-initials) {
      margin-right: 8px;
    }
    
    .completion-pill {
      display: inline-flex;
      align-items: center;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      padding: 1px 3px 1px 3px;
      font-weight: bold;
    }
    
    .completion-pill .completion-text {
      color: #666;
    }
    
    .completion-text {
      color: #11A928;
      font-size: 11px;
    }
    
    .completion-timestamp {
      color: #11A928;
      font-size: 11px;
    }
    
    .item-help {
      font-size: 12px;
      color: #666;
      line-height: 1.4;
      display: none;
      margin-top: 6px;
      margin-bottom: 12px
    }
    
    .item-help.show {
      display: block;
    }
    
    .info-button {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      color: #666;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 8px;
      transition: all 0.2s ease;
    }
    
    .info-button:hover {
      background: #e9ecef;
      color: #333;
      border-color: #ccc;
    }
    
    .footer {
      background: #f8f9fa;
      padding: 12px 16px;
      border-top: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .close-button {
      background: #0A1264;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .close-button:hover {
      background: #5a6268;
    }
    
    .validate-button {
      background: #0A1264;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: background-color 0.2s ease;
    }
    
    .validate-button:hover {
      background: #040c61;
    }
    
    .validate-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .validation-item {
      padding: 16px;
      margin-bottom: 12px;
      border-radius: 6px;
      border-left: 4px solid;
      display: flex;
      align-items: flex-start;
    }
    
    .validation-pass {
      background: #f0f9ff;
      border-left-color: #28a745;
    }
    
    .validation-fail {
      background: #fef2f2;
      border-left-color: #dc3545;
    }
    
    .validation-icon {
      margin-right: 12px;
      font-size: 18px;
      margin-top: 2px;
    }
    
    .validation-content {
      flex: 1;
    }
    
    .validation-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }
    
    .validation-pass .validation-title {
      color: #155724;
    }
    
    .validation-fail .validation-title {
      color: #721c24;
    }
    
    .validation-description {
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    
    .validation-details {
      font-size: 11px;
      color: #888;
      white-space: pre-line;
      line-height: 1.4;
    }
    
    .frame-link {
      color: #18a0fb;
      text-decoration: none;
      cursor: pointer;
    }
    
    .frame-link:hover {
      text-decoration: underline;
    }
    
    .page-info {
      font-size: 11px;
      color: #666;
    }
    
    .peer-review-section {
      margin-bottom: 20px;
    }
    
    .review-comment-section {
      margin-top: 16px;
      padding: 16px;
      background: #f8f9fa;
      border-radius: 6px;
    }
    
    .comment-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }
    
    .review-comment-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      font-size: 13px;
      font-family: inherit;
      line-height: 1.4;
      resize: vertical;
      min-height: 80px;
    }
    
    .review-comment-input:focus {
      outline: none;
      border-color: #0A1264;
      box-shadow: 0 0 0 2px rgba(10, 18, 100, 0.1);
    }
    
    .review-comment-input::placeholder {
      color: #999;
    }
    
    .comment-input-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .add-comment-btn {
      align-self: flex-end;
      background: #0A1264;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    
    .add-comment-btn:hover {
      background: #040c61;
    }
    
    .add-comment-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .comments-list {
      margin-top: 16px;
    }
    
    .comment-item {
      background: white;
      border: 1px solid #e9ecef;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .comment-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .comment-author {
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      font-size: 12px;
      color: #333;
    }
    
    .comment-avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 1px solid #e9ecef;
      flex-shrink: 0;
    }
    
    .comment-initials {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: #007acc;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      flex-shrink: 0;
    }
    
    .comment-date {
      font-size: 11px;
      color: #666;
    }
    
    .delete-comment-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
      padding: 2px 4px;
      border-radius: 3px;
      opacity: 0.6;
      transition: opacity 0.2s, background-color 0.2s;
    }
    
    .delete-comment-btn:hover {
      opacity: 1;
      background-color: #f8f9fa;
    }
    
    .delete-comment-btn:active {
      background-color: #e9ecef;
    }
    
    .comment-text {
      font-size: 13px;
      color: #333;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
  </style>
</head>
<body>
  
  <div class="tabs">
    <div class="tab active" onclick="switchTab('checklist')">
      <span class="tab-radio"></span>
      Manual Checks
    </div>
    <div class="tab" onclick="switchTab('validate')">
      <span class="tab-radio"></span>
      Auto Checks
    </div>
    <div class="tab" onclick="switchTab('peer-review')">
      <span class="tab-radio"></span>
      Peer Review
    </div>
  </div>
  
  <div class="content">
    <!-- Checklist Tab -->
    <div id="checklist-tab" class="tab-content active">
      <div class="section-header">
        <div class="section-title">üìã Self Review Checklist</div>
        <div class="section-subtitle">Please complete this checklist before requesting a review.</div>
      </div>
      
      <div class="checklist-items">
         <div class="checklist-item">
           <input type="checkbox" id="check1" class="checkbox" onchange="toggleCheck('check1')">
           <div class="item-content">
             <div class="item-label">My work is in the correct Figma file</div>
             <div id="check1-completion" class="item-completion"></div>
             <div id="check1-help" class="item-help">
              Make sure your design work lives in the right product file for the semester. For example, a Risk Modeler feature launching in Istanbul should be in the <strong>RM ‚Äì Istanbul</strong> file.
             </div>
           </div>
           <div class="info-button" onclick="toggleHelp('check1')">
             ‚ÑπÔ∏è
           </div>
         </div>
        
         <div class="checklist-item">
           <input type="checkbox" id="check2" class="checkbox" onchange="toggleCheck('check2')">
           <div class="item-content">
             <div class="item-label">My designs are annotated where needed</div>
             <div id="check2-completion" class="item-completion"></div>
             <div id="check2-help" class="item-help">
              Annotations make peer reviews smoother and help engineers understand important details. Add them wherever you need to highlight key interactions or decisions.
             </div>
           </div>
           <div class="info-button" onclick="toggleHelp('check2')">
             ‚ÑπÔ∏è
           </div>
         </div>
        
         <div class="checklist-item">
           <input type="checkbox" id="check3" class="checkbox" onchange="toggleCheck('check3')">
           <div class="item-content">
             <div class="item-label">My work has been approved by the FSG</div>
             <div id="check3-completion" class="item-completion"></div>
             <div id="check3-help" class="item-help">
              To avoid extra review cycles, ensure the FSG has reviewed and approved your designs before starting peer review.
             </div>
           </div>
           <div class="info-button" onclick="toggleHelp('check3')">
             ‚ÑπÔ∏è
           </div>
         </div>
        
         <div class="checklist-item">
           <input type="checkbox" id="check4" class="checkbox" onchange="toggleCheck('check4')">
           <div class="item-content">
             <div class="item-label">I've wired up at least a basic prototype</div>
             <div id="check4-completion" class="item-completion"></div>
             <div id="check4-help" class="item-help">
              Your screens should be navigable like a slide deck (arrow keys forward/back). Each workflow should also have a "flow" starting point for easy navigation from the prototype view.
             </div>
           </div>
           <div class="info-button" onclick="toggleHelp('check4')">
             ‚ÑπÔ∏è
           </div>
         </div>
        
         <div class="checklist-item">
           <input type="checkbox" id="check5" class="checkbox" onchange="toggleCheck('check5')">
           <div class="item-content">
             <div class="item-label">All designs are using the latest Radius components</div>
             <div id="check5-completion" class="item-completion"></div>
             <div id="check5-help" class="item-help">
               Please ensure that components from older Radius libraries files(e.g., Radius v1.0, RadGrid Beta, etc) are not in use in your designs.
             </div>
           </div>
           <div class="info-button" onclick="toggleHelp('check5')">
             ‚ÑπÔ∏è
           </div>
         </div>
      </div>
    </div>
    
    <!-- Validate Tab -->
    <div id="validate-tab" class="tab-content">
      <div class="validation-header">
        <div class="validation-text">
          <div class="section-title">üîç Automated Validation</div>
          <div class="section-subtitle">System checks for common issues.</div>
        </div>
        <button id="run-validation-btn" class="validate-button" onclick="runValidation()">
          Rerun Validation
        </button>
      </div>
      
      <div id="validation-results">
        <div style="text-align: center; color: #666; padding: 40px 20px;">
          Running validation...
        </div>
      </div>
    </div>
    
    <!-- Peer Review Tab -->
    <div id="peer-review-tab" class="tab-content">
      <div class="section-header">
        <div class="section-title">üë• Peer Review</div>
        <div class="section-subtitle">Reviewer sign-off section.</div>
      </div>
      
      <div class="peer-review-section">
        <div class="checklist-item">
          <input type="checkbox" id="peer-reviewed" class="checkbox" onchange="togglePeerReview()">
          <div class="item-content">
            <div class="item-label">This feature has been peer reviewed</div>
            <div id="peer-reviewed-completion" class="item-completion"></div>
          </div>
        </div>
        
        <div class="review-comment-section">
          <label for="new-comment" class="comment-label">Add Review Comment:</label>
          <div class="comment-input-container">
            <textarea 
              id="new-comment" 
              class="review-comment-input" 
              placeholder="Add feedback, notes, or suggestions about this design..."
              rows="3"
            ></textarea>
            <button class="add-comment-btn" onclick="addComment()">Add Comment</button>
          </div>
          
          <div id="comments-list" class="comments-list">
            <!-- Comments will be displayed here -->
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="footer">
    <div class="page-info">Reviewing: <span id="page-name">Loading...</span></div>

    <button class="close-button" onclick="closePlugin()">Close</button>
  </div>

  <script>
    let currentTab = 'checklist';
    let checkStates = {
      check1: false,
      check2: false,
      check3: false,
      check4: false,
      check5: false
    };
    let currentValidationResults = null;
    
    // Tab switching
    function switchTab(tabName) {
      // Update tab states
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      // Activate selected tab
      event.target.closest('.tab').classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');
      
      currentTab = tabName;
    }
    
    // Checkbox toggling
    function toggleCheck(checkId) {
      const checkbox = document.getElementById(checkId);
      const isChecked = checkbox.checked;
      
      checkStates[checkId] = isChecked;
      
      if (isChecked) {
        // Add completion text with emoji
        const emojis = ['üî•', 'üöÄ', 'üëç', 'üíØ', 'üòé'];
        const checkIndex = parseInt(checkId.replace('check', '')) - 1;
        const emoji = emojis[checkIndex];
        
        // For now, show placeholder until the plugin responds with actual data
        document.getElementById(checkId + '-completion').innerHTML = 
          `<span class="completion-text">Completed by </span><div class="completion-pill"><div class="user-initials">?</div><span class="completion-text">[Username]</span></div><span class="completion-timestamp">on [Timestamp]</span> ${emoji}`;
      } else {
        document.getElementById(checkId + '-completion').textContent = '';
      }
      
      // Update tab completion state
      updateTabCompletion();
      
      // Save to plugin
      saveCheckStates();
    }
    
    // Help text toggling
    function toggleHelp(checkId) {
      const helpElement = document.getElementById(checkId + '-help');
      const isVisible = helpElement.classList.contains('show');
      
      // Hide all help content first
      document.querySelectorAll('.item-help').forEach(help => {
        help.classList.remove('show');
      });
      
      // Show the clicked help content if it wasn't visible
      if (!isVisible) {
        helpElement.classList.add('show');
      }
    }
    
    // Helper function to get user initials
    function getUserInitials(userName) {
      if (!userName || userName === 'Unknown User') return '?';
      return userName.split(' ')
        .map(name => name.charAt(0).toUpperCase())
        .slice(0, 2)
        .join('');
    }
    
    // Helper function to create avatar HTML
    function createAvatarHtml(userPhoto, userName, className = 'user-avatar') {
      // Check if we have a valid photo URL (not null, undefined, or empty)
      const hasValidPhoto = userPhoto && typeof userPhoto === 'string' && userPhoto.trim().length > 0;
      
      if (hasValidPhoto) {
        return `<img src="${userPhoto}" alt="${userName}" class="${className}" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                     onload="this.style.display='block'; this.nextElementSibling.style.display='none';">
                <div class="${className.replace('avatar', 'initials')}" style="display: none;">${getUserInitials(userName)}</div>`;
      } else {
        return `<div class="${className.replace('avatar', 'initials')}">${getUserInitials(userName)}</div>`;
      }
    }
    
    // Update tab completion indicators for all tabs
    function updateTabCompletion() {
      const tabs = document.querySelectorAll('.tab');
      
      // Manual Checks tab (first tab)
      const manualChecksComplete = Object.values(checkStates).every(state => state);
      if (manualChecksComplete) {
        tabs[0].classList.add('completed');
      } else {
        tabs[0].classList.remove('completed');
      }
      
      // Auto Checks tab (second tab)
      let autoChecksComplete = false;
      if (currentValidationResults) {
        autoChecksComplete = currentValidationResults.frameNames.passed && 
                            currentValidationResults.overviewBoard.passed && 
                            currentValidationResults.sections.passed;
      }
      if (autoChecksComplete) {
        tabs[1].classList.add('completed');
      } else {
        tabs[1].classList.remove('completed');
      }
      
      // Peer Review tab (third tab)
      const peerReviewCheckbox = document.getElementById('peer-reviewed');
      const peerReviewComplete = (currentPeerReviewData && currentPeerReviewData.reviewed) || 
                                 (peerReviewCheckbox && peerReviewCheckbox.checked);

      
      if (peerReviewComplete) {
        tabs[2].classList.add('completed');
      } else {
        tabs[2].classList.remove('completed');
      }
    }
    
    // Save check states to plugin
    function saveCheckStates() {
      const manualChecks = {
        appropriateFile: checkStates.check1,
        annotations: checkStates.check2,
        fsgApproval: checkStates.check3,
        prototype: checkStates.check4,
        radiusComponents: checkStates.check5
      };
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-manual-checks',
          manualChecks: manualChecks
        } 
      }, '*');
    }
    
    // Close plugin
    function closePlugin() {
      parent.postMessage({ pluginMessage: { type: 'close-plugin' } }, '*');
    }
    
    // Message handling from plugin
    window.onmessage = (event) => {
      if (event.data.pluginMessage) {
        if (event.data.pluginMessage.type === 'load-saved-checks') {
          loadSavedChecks(event.data.pluginMessage.savedChecks);
        } else if (event.data.pluginMessage.type === 'page-info') {
          document.getElementById('page-name').textContent = event.data.pluginMessage.pageName;
        } else if (event.data.pluginMessage.type === 'checks-updated') {
          updateCheckInfo(event.data.pluginMessage.checks);
        } else if (event.data.pluginMessage.type === 'validation-results') {
          displayValidationResults(event.data.pluginMessage.results);
        } else if (event.data.pluginMessage.type === 'auto-validation-results') {
          displayValidationResults(event.data.pluginMessage.results);
        } else if (event.data.pluginMessage.type === 'load-peer-review') {
          loadPeerReviewData(event.data.pluginMessage.peerReview);
        } else if (event.data.pluginMessage.type === 'peer-review-updated') {
          updatePeerReviewInfo(event.data.pluginMessage.peerReview);
        } else if (event.data.pluginMessage.type === 'comment-added') {
          updatePeerReviewInfo(event.data.pluginMessage.peerReview);
        } else if (event.data.pluginMessage.type === 'uncheck-permission-granted') {
          // Permission granted, proceed with unchecking
          document.getElementById('peer-reviewed-completion').textContent = '';
          savePeerReviewData();
        } else if (event.data.pluginMessage.type === 'uncheck-permission-denied') {
          // Permission denied, revert checkbox and show message
          const checkbox = document.getElementById('peer-reviewed');
          checkbox.checked = true; // Revert to checked state
          alert(`Only ${event.data.pluginMessage.originalReviewer} can uncheck this peer review.`);
        } else if (event.data.pluginMessage.type === 'current-user-info') {
          // Hide delete buttons for comments not made by current user
          const currentUser = event.data.pluginMessage.currentUser;
          document.querySelectorAll('.delete-comment-btn').forEach(btn => {
            const commentUser = btn.getAttribute('data-comment-user');
            if (commentUser !== currentUser) {
              btn.style.display = 'none';
            }
          });
        } else if (event.data.pluginMessage.type === 'comment-deleted') {
          // Remove the comment from UI and refresh display
          loadPeerReviewData(event.data.pluginMessage.peerReview);
        } else if (event.data.pluginMessage.type === 'delete-permission-denied') {
          alert('You can only delete your own comments.');
        }
      }
    };
    
    // Load saved check states
    function loadSavedChecks(savedChecks) {
      if (savedChecks) {
        // Handle both old format (boolean) and new format (object with timestamp/user)
        const normalizedChecks = {
          appropriateFile: typeof savedChecks.appropriateFile === 'object' ? savedChecks.appropriateFile : { checked: savedChecks.appropriateFile, timestamp: null, user: null },
          annotations: typeof savedChecks.annotations === 'object' ? savedChecks.annotations : { checked: savedChecks.annotations, timestamp: null, user: null },
          fsgApproval: typeof savedChecks.fsgApproval === 'object' ? savedChecks.fsgApproval : { checked: savedChecks.fsgApproval, timestamp: null, user: null },
          prototype: typeof savedChecks.prototype === 'object' ? savedChecks.prototype : { checked: savedChecks.prototype || false, timestamp: null, user: null },
          radiusComponents: typeof savedChecks.radiusComponents === 'object' ? savedChecks.radiusComponents : { checked: savedChecks.radiusComponents || false, timestamp: null, user: null }
        };
        
        checkStates.check1 = normalizedChecks.appropriateFile.checked;
        checkStates.check2 = normalizedChecks.annotations.checked;
        checkStates.check3 = normalizedChecks.fsgApproval.checked;
        checkStates.check4 = normalizedChecks.prototype.checked;
        checkStates.check5 = normalizedChecks.radiusComponents.checked;
        
        // Update UI
        Object.keys(checkStates).forEach(checkId => {
          const checkbox = document.getElementById(checkId);
          const checkIndex = parseInt(checkId.replace('check', '')) - 1;
          const checkKeys = ['appropriateFile', 'annotations', 'fsgApproval', 'prototype', 'radiusComponents'];
          const checkKey = checkKeys[checkIndex];
          const checkData = normalizedChecks[checkKey];
          
          if (checkStates[checkId]) {
            checkbox.checked = true;
            
            // Add completion text with actual timestamp and user
            const emojis = ['üî•', 'üöÄ', 'üëç', 'üíØ', 'üòé'];
            const emoji = emojis[checkIndex];
            
                            if (checkData.timestamp && checkData.user) {
                  const date = new Date(checkData.timestamp);
                  const formattedDate = date.toLocaleDateString();
                  const avatarHtml = createAvatarHtml(checkData.userPhoto, checkData.user);
                  document.getElementById(checkId + '-completion').innerHTML = 
                    `<span class="completion-text">Completed by </span><div class="completion-pill">${avatarHtml}<span class="completion-text">${checkData.user}</span></div><span class="completion-timestamp">on ${formattedDate}</span> ${emoji}`;
                } else {
                  document.getElementById(checkId + '-completion').innerHTML = 
                    `<span class="completion-text">Completed by </span><div class="completion-pill"><div class="user-initials">?</div><span class="completion-text">[Username]</span></div><span class="completion-timestamp">on [Timestamp]</span> ${emoji}`;
                }
          }
        });
        
        updateTabCompletion();
      }
    }
    
    // Update check info with actual timestamp and user data
    function updateCheckInfo(checks) {
      const checkKeys = ['appropriateFile', 'annotations', 'fsgApproval', 'prototype', 'radiusComponents'];
      const emojis = ['üî•', 'üöÄ', 'üëç', 'üíØ', 'üòé'];
      
      checkKeys.forEach((checkKey, index) => {
        const checkId = `check${index + 1}`;
        const checkData = checks[checkKey];
        const emoji = emojis[index];
        
        if (checkData.checked && checkData.timestamp && checkData.user) {
          const date = new Date(checkData.timestamp);
          const formattedDate = date.toLocaleDateString();
          const avatarHtml = createAvatarHtml(checkData.userPhoto, checkData.user);
          document.getElementById(checkId + '-completion').innerHTML = 
            `<span class="completion-text">Completed by </span><div class="completion-pill">${avatarHtml}<span class="completion-text">${checkData.user}</span></div><span class="completion-timestamp">on ${formattedDate}</span> ${emoji}`;
        }
      });
    }
    
    // Run validation
    function runValidation() {
      const button = document.getElementById('run-validation-btn');
      button.disabled = true;
      button.textContent = 'Running...';
      
      // Send validation request to plugin
      parent.postMessage({ 
        pluginMessage: { 
          type: 'run-validation'
        } 
      }, '*');
    }
    
    // Select frame in Figma
    function selectFrame(frameId) {
      parent.postMessage({ 
        pluginMessage: { 
          type: 'select-frame',
          frameId: frameId
        } 
      }, '*');
    }
    
    // Store current peer review data for validation
    let currentPeerReviewData = null;
    
    // Toggle peer review checkbox
    function togglePeerReview() {
      const checkbox = document.getElementById('peer-reviewed');
      const isChecked = checkbox.checked;
      
      // If trying to uncheck, validate permission first
      if (!isChecked && currentPeerReviewData && currentPeerReviewData.reviewed) {
        // Send validation request to plugin
        parent.postMessage({ 
          pluginMessage: { 
            type: 'validate-uncheck-permission',
            currentReviewUser: currentPeerReviewData.user
          } 
        }, '*');
        return; // Don't proceed with save until validation
      }
      
      if (isChecked) {
        // Show placeholder until plugin responds with actual data
        document.getElementById('peer-reviewed-completion').innerHTML = 
          '<span class="completion-text">Peer reviewed by </span><div class="completion-pill"><div class="user-initials">?</div><span class="completion-text">[Username]</span></div><span class="completion-timestamp">at [Timestamp]</span> ‚úÖ';
      } else {
        document.getElementById('peer-reviewed-completion').textContent = '';
      }
      
      savePeerReviewData();
      
      // Update tab completion immediately
      updateTabCompletion();
    }
    
    // Save peer review checkbox state only
    function savePeerReviewData() {
      const isChecked = document.getElementById('peer-reviewed').checked;
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'save-peer-review',
          peerReview: {
            reviewed: isChecked
          }
        } 
      }, '*');
    }
    
    // Add new comment
    function addComment() {
      const textarea = document.getElementById('new-comment');
      const commentText = textarea.value.trim();
      
      if (!commentText) {
        return; // Don't add empty comments
      }
      
      // Disable button while saving
      const button = document.querySelector('.add-comment-btn');
      button.disabled = true;
      button.textContent = 'Adding...';
      
      parent.postMessage({ 
        pluginMessage: { 
          type: 'add-comment',
          comment: commentText
        } 
      }, '*');
      
      // Clear the textarea
      textarea.value = '';
    }
    
    // Load saved peer review data
    function loadPeerReviewData(peerReview) {
      // Store current data for validation
      currentPeerReviewData = peerReview;
      
      if (peerReview) {
        const checkbox = document.getElementById('peer-reviewed');
        checkbox.checked = peerReview.reviewed || false;
        
        if (peerReview.reviewed && peerReview.timestamp && peerReview.user) {
          const date = new Date(peerReview.timestamp);
          const formattedDate = date.toLocaleDateString();
          const avatarHtml = createAvatarHtml(peerReview.userPhoto, peerReview.user);
          document.getElementById('peer-reviewed-completion').innerHTML = 
            `<span class="completion-text">Peer reviewed by </span><div class="completion-pill">${avatarHtml}<span class="completion-text">${peerReview.user}</span></div><span class="completion-timestamp">at ${formattedDate}</span> ‚úÖ`;
        }
        
        // Load comments (always call displayComments to handle empty arrays)
        displayComments(peerReview.comments || []);
      } else {
        // No peer review data, clear everything
        const checkbox = document.getElementById('peer-reviewed');
        checkbox.checked = false;
        document.getElementById('peer-reviewed-completion').innerHTML = '';
        displayComments([]);
      }
      
      // Update tab completion after loading peer review data
      updateTabCompletion();
    }
    
    // Update peer review info with actual timestamp and user data
    function updatePeerReviewInfo(peerReview) {
      // Update stored data
      currentPeerReviewData = peerReview;
      
      if (peerReview.reviewed && peerReview.timestamp && peerReview.user) {
        const date = new Date(peerReview.timestamp);
        const formattedDate = date.toLocaleDateString();
        const avatarHtml = createAvatarHtml(peerReview.userPhoto, peerReview.user);
        document.getElementById('peer-reviewed-completion').innerHTML = 
          `<span class="completion-text">Peer reviewed by </span><div class="completion-pill">${avatarHtml}<span class="completion-text">${peerReview.user}</span></div><span class="completion-timestamp">on ${formattedDate}</span> ‚úÖ`;
      } else if (peerReview.reviewed) {
        // Checkbox is checked but no timestamp/user data yet (placeholder)
        document.getElementById('peer-reviewed-completion').innerHTML = 
          '<span class="completion-text">Peer reviewed by </span><div class="completion-pill"><div class="user-initials">?</div><span class="completion-text">[Username]</span></div><span class="completion-timestamp">on [Timestamp]</span> ‚úÖ';
      } else {
        // Not reviewed, clear completion text
        document.getElementById('peer-reviewed-completion').innerHTML = '';
      }
      
      // Update comments display
      if (peerReview.comments) {
        displayComments(peerReview.comments);
      }
      
      // Re-enable add comment button
      const button = document.querySelector('.add-comment-btn');
      button.disabled = false;
      button.textContent = 'Add Comment';
      
      // Update tab completion after updating peer review info
      updateTabCompletion();
    }
    
    // Display comments in the UI
    function displayComments(comments) {
      const commentsList = document.getElementById('comments-list');
      
      if (!comments || comments.length === 0) {
        commentsList.innerHTML = '';
        return;
      }
      
      const commentsHtml = comments.map((comment, index) => {
        const date = new Date(comment.timestamp);
        const formattedDate = date.toLocaleDateString();
        
        const avatarHtml = createAvatarHtml(comment.userPhoto, comment.user, 'comment-avatar');
        
        // For old comments without IDs, generate the same ID format as backend
        const commentId = comment.id || `comment_${comment.timestamp}_${index}`;
        
        return `
          <div class="comment-item" data-comment-id="${commentId}">
            <div class="comment-header">
              <span class="comment-author">
                ${avatarHtml}
                <span>${comment.user}</span>
              </span>
              <div class="comment-actions">
                <span class="comment-date">${formattedDate}</span>
                <button class="delete-comment-btn" data-comment-id="${commentId}" data-comment-user="${comment.user}" title="Delete comment">üóëÔ∏è</button>
              </div>
            </div>
            <div class="comment-text">${comment.text}</div>
          </div>
        `;
      }).join('');
      
      commentsList.innerHTML = commentsHtml;
      
      // Add event listeners to delete buttons
      document.querySelectorAll('.delete-comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const commentId = this.getAttribute('data-comment-id');
          const commentUser = this.getAttribute('data-comment-user');
          deleteComment(commentId, commentUser);
        });
      });
      
      // Hide delete buttons for comments not made by current user
      hideDeleteButtonsForOtherUsers();
    }
    
    // Hide delete buttons for comments not made by current user
    function hideDeleteButtonsForOtherUsers() {
      // We'll get the current user from the plugin
      parent.postMessage({ pluginMessage: { type: 'get-current-user' } }, '*');
    }
    
    // Delete a comment (with permission check)
    function deleteComment(commentId, commentUser) {
      // Confirm deletion
      if (!confirm('Are you sure you want to delete this comment?')) {
        return;
      }
      
      // Send delete request to plugin with permission validation
      parent.postMessage({ 
        pluginMessage: { 
          type: 'delete-comment', 
          commentId: commentId,
          commentUser: commentUser
        } 
      }, '*');
    }
    
    // Display validation results
    function displayValidationResults(results) {
      // Store results globally for tab completion checking
      currentValidationResults = results;
      
      const resultsDiv = document.getElementById('validation-results');
      const button = document.getElementById('run-validation-btn');
      
      // Reset button
      button.disabled = false;
      button.textContent = 'Rerun Validation';
      
      // Clear previous results
      resultsDiv.innerHTML = '';
      
      // Update tab completion after storing results
      updateTabCompletion();
      
      // Create validation items
      const validations = [
        {
          title: 'Frame Names',
          result: results.frameNames,
          description: 'All top-level frames should have descriptive names.',
          icon: 'üìù'
        },
        {
          title: 'Overview Board',
          result: results.overviewBoard,
          description: 'An overview board is required before you can submit your work for review.',
          icon: 'üìã'
        },
        {
          title: 'Frames in Sections',
          result: results.sections,
          description: 'All top-level frames should be wrapped in workflow sections.',
          icon: 'üì¶'
        }
      ];
      
      validations.forEach(validation => {
        const div = document.createElement('div');
        div.className = `validation-item ${validation.result.passed ? 'validation-pass' : 'validation-fail'}`;
        
        let details = '';
        if (!validation.result.passed) {
          if (validation.title === 'Frame Names' && validation.result.count > 0) {
            // Create clickable links for each frame with issues (deduplicate by frame ID)
            const uniqueFrames = new Map();
            validation.result.issues.forEach(issue => {
              if (issue.frame && !uniqueFrames.has(issue.frame.id)) {
                uniqueFrames.set(issue.frame.id, issue);
              }
            });
            
            const frameLinks = Array.from(uniqueFrames.values()).map(issue => {
              return `<a href="#" onclick="selectFrame('${issue.frame.id}')" class="frame-link">${issue.name}</a>`;
            });
            
            details = `Naming issues found with the following frames:\n‚Ä¢ ${frameLinks.join('\n‚Ä¢ ')}`;
          } else if (validation.title === 'Overview Board') {
            details = 'No overview board found in top-level frames';
          } else if (validation.title === 'Sections') {
            details = `${validation.result.framesInSections}/${validation.result.totalFrames} top-level frames in sections`;
          }
        } else {
          if (validation.title === 'Frame Names') {
            details = `${validation.result.totalFrames} top-level frames have good names`;
          }
        }
        
        div.innerHTML = `
          <div class="validation-icon">${validation.icon}</div>
          <div class="validation-content">
            <div class="validation-title">
              ${validation.result.passed ? '‚úÖ' : '‚ùå'} ${validation.title}
            </div>
            <div class="validation-description">${validation.description}</div>
            ${details ? `<div class="validation-details">${details}</div>` : ''}
          </div>
        `;
        
        resultsDiv.appendChild(div);
      });
    }
  </script>
</body>
</html> 